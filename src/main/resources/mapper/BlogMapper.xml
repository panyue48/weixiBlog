<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.weixi.blog.mapper.BlogMapper">

    <!-- 博客结果映射 -->
    <resultMap id="BlogMap" type="com.weixi.blog.entity.Blog">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="first_picture" property="firstPicture"/>
        <result column="views" property="views"/>
        <result column="type_id" property="typeId"/>
        <result column="user_id" property="userId"/>
        <result column="published" property="published"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 博客VO结果映射 -->
    <resultMap id="BlogVOMap" type="com.weixi.blog.vo.BlogVO">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="first_picture" property="firstPicture"/>
        <result column="views" property="views"/>
        <result column="type_id" property="typeId"/>
        <result column="type_name" property="typeName"/>
        <result column="user_id" property="userId"/>
        <result column="user_nickname" property="userNickname"/>
        <result column="user_avatar" property="userAvatar"/>
        <result column="published" property="published"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <collection property="tags" ofType="com.weixi.blog.vo.TagVO">
            <id column="tag_id" property="id"/>
            <result column="tag_name" property="name"/>
            <result column="tag_color" property="color"/>
        </collection>
    </resultMap>

    <!-- 分页查询博客列表 -->
    <select id="selectBlogPage" resultMap="BlogVOMap">
        SELECT 
            b.id,
            b.title,
            b.content,
            b.first_picture,
            b.views,
            b.type_id,
            t.name AS type_name,
            b.user_id,
            u.nickname AS user_nickname,
            u.avatar AS user_avatar,
            b.published,
            b.create_time,
            b.update_time,
            tag.id AS tag_id,
            tag.name AS tag_name,
            tag.color AS tag_color
        FROM t_blog b
        LEFT JOIN t_type t ON b.type_id = t.id
        LEFT JOIN t_user u ON b.user_id = u.id
        LEFT JOIN t_blog_tags bt ON b.id = bt.blog_id
        LEFT JOIN t_tag tag ON bt.tag_id = tag.id
        <where>
            <if test="published != null">
                AND b.published = #{published}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (b.title LIKE CONCAT('%', #{keyword}, '%') 
                     OR b.content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="typeId != null">
                AND b.type_id = #{typeId}
            </if>
            <if test="tagId != null">
                AND EXISTS (
                    SELECT 1 FROM t_blog_tags bt2 
                    WHERE bt2.blog_id = b.id AND bt2.tag_id = #{tagId}
                )
            </if>
        </where>
        ORDER BY b.create_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>

    <!-- 查询总数 -->
    <select id="countBlogs" resultType="int">
        SELECT COUNT(DISTINCT b.id)
        FROM t_blog b
        <where>
            <if test="published != null">
                AND b.published = #{published}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (b.title LIKE CONCAT('%', #{keyword}, '%') 
                     OR b.content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="typeId != null">
                AND b.type_id = #{typeId}
            </if>
            <if test="tagId != null">
                AND EXISTS (
                    SELECT 1 FROM t_blog_tags bt2 
                    WHERE bt2.blog_id = b.id AND bt2.tag_id = #{tagId}
                )
            </if>
        </where>
    </select>

    <!-- 根据ID查询博客详情 -->
    <select id="selectBlogDetailById" resultMap="BlogVOMap">
        SELECT 
            b.id,
            b.title,
            b.content,
            b.first_picture,
            b.views,
            b.type_id,
            t.name AS type_name,
            b.user_id,
            u.nickname AS user_nickname,
            u.avatar AS user_avatar,
            b.published,
            b.create_time,
            b.update_time,
            tag.id AS tag_id,
            tag.name AS tag_name,
            tag.color AS tag_color
        FROM t_blog b
        LEFT JOIN t_type t ON b.type_id = t.id
        LEFT JOIN t_user u ON b.user_id = u.id
        LEFT JOIN t_blog_tags bt ON b.id = bt.blog_id
        LEFT JOIN t_tag tag ON bt.tag_id = tag.id
        WHERE b.id = #{id}
    </select>

    <!-- 插入博客 -->
    <insert id="insert" parameterType="com.weixi.blog.entity.Blog" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_blog (title, content, first_picture, views, type_id, user_id, published, create_time, update_time)
        VALUES (#{title}, #{content}, #{firstPicture}, #{views}, #{typeId}, #{userId}, #{published}, NOW(), NOW())
    </insert>

    <!-- 更新博客 -->
    <update id="updateById" parameterType="com.weixi.blog.entity.Blog">
        UPDATE t_blog
        SET title = #{title},
            content = #{content},
            first_picture = #{firstPicture},
            type_id = #{typeId},
            published = #{published},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 删除博客 -->
    <delete id="deleteById">
        DELETE FROM t_blog WHERE id = #{id}
    </delete>

    <!-- 根据ID查询博客 -->
    <select id="selectById" resultMap="BlogMap">
        SELECT 
            id,
            title,
            content,
            first_picture,
            views,
            type_id,
            user_id,
            published,
            create_time,
            update_time
        FROM t_blog
        WHERE id = #{id}
    </select>

    <!-- 增加浏览量 -->
    <update id="incrementViews">
        UPDATE t_blog 
        SET views = views + 1 
        WHERE id = #{id}
    </update>

</mapper>

